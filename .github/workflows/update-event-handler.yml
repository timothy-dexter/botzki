name: PR Webhook Notification

on:
  pull_request:
    types: [opened]
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: startsWith(github.event.pull_request.head.ref, 'job/')
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Gather job results and notify
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BRANCH="${{ github.event.pull_request.head.ref }}"
          JOB_ID="${BRANCH#job/}"

          # 1. Read job.md (on disk after checkout)
          JOB_CONTENT=""
          if [ -f "workspace/job.md" ]; then
            JOB_CONTENT=$(head -c 10000 workspace/job.md)
          fi

          # 2. Get last commit message via gh CLI
          COMMIT_MSG=$(gh pr view "$PR_NUMBER" --json commits --jq '.commits[-1].messageHeadline' --repo "${{ github.repository }}" 2>/dev/null || echo "")

          # 3. Get changed files (names only)
          CHANGED_FILES=$(gh pr diff "$PR_NUMBER" --name-only --repo "${{ github.repository }}" 2>/dev/null || echo "")

          # 4. Get PR status
          PR_STATUS=$(gh pr view "$PR_NUMBER" --json state --jq '.state' --repo "${{ github.repository }}" 2>/dev/null || echo "open")

          # 5. Read log file (find .jsonl in workspace/logs/{jobId}/)
          LOG_CONTENT=""
          LOG_DIR="workspace/logs/${JOB_ID}"
          if [ -d "$LOG_DIR" ]; then
            LOG_FILE=$(find "$LOG_DIR" -name "*.jsonl" -type f | head -1)
            if [ -n "$LOG_FILE" ]; then
              LOG_CONTENT=$(tail -c 50000 "$LOG_FILE")
            fi
          fi

          # 6. Build JSON payload with jq (handles escaping safely)
          jq -n \
            --arg action "${{ github.event.action }}" \
            --arg html_url "${{ github.event.pull_request.html_url }}" \
            --arg title "${{ github.event.pull_request.title }}" \
            --argjson number "${{ github.event.pull_request.number }}" \
            --arg head_ref "$BRANCH" \
            --arg job "$JOB_CONTENT" \
            --arg commit_message "$COMMIT_MSG" \
            --arg changed_files "$CHANGED_FILES" \
            --arg pr_status "$PR_STATUS" \
            --arg log "$LOG_CONTENT" \
            '{
              action: $action,
              pull_request: {
                html_url: $html_url,
                title: $title,
                number: $number,
                head: { ref: $head_ref }
              },
              job_results: {
                job: $job,
                commit_message: $commit_message,
                changed_files: ($changed_files | split("\n") | map(select(length > 0))),
                pr_status: $pr_status,
                log: $log
              }
            }' > /tmp/payload.json

          # 7. Send to event handler
          curl -s -X POST "${{ vars.GH_WEBHOOK_URL }}/github/webhook" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: pull_request" \
            -H "X-GitHub-Webhook-Secret-Token: ${{ secrets.GH_WEBHOOK_SECRET }}" \
            -d @/tmp/payload.json
