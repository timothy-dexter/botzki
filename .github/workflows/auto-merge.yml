name: Auto-Merge Job PR

on:
  pull_request:
    types: [opened]
    branches: [main]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: startsWith(github.event.pull_request.head.ref, 'job/')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check AUTO_MERGE setting
        id: check-setting
        run: |
          AUTO_MERGE="${{ vars.AUTO_MERGE }}"
          if [ "$AUTO_MERGE" = "false" ]; then
            echo "Auto-merge disabled via AUTO_MERGE=false"
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "Auto-merge enabled"
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Check ALLOWED_PATHS
        if: steps.check-setting.outputs.enabled == 'true'
        id: check-paths
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ALLOWED_PATHS="${{ vars.ALLOWED_PATHS }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Default: only workspace allowed
          if [ -z "$ALLOWED_PATHS" ]; then
            ALLOWED_PATHS="/workspace"
          fi

          # Normalize: ensure each prefix starts with /
          IFS=',' read -ra RAW_PREFIXES <<< "$ALLOWED_PATHS"
          PREFIXES=()
          for p in "${RAW_PREFIXES[@]}"; do
            trimmed=$(echo "$p" | xargs)
            [ -z "$trimmed" ] && continue
            # Ensure leading /
            [[ "$trimmed" != /* ]] && trimmed="/$trimmed"
            PREFIXES+=("$trimmed")
          done

          # "/" means everything allowed
          for p in "${PREFIXES[@]}"; do
            if [ "$p" = "/" ]; then
              echo "All paths allowed (ALLOWED_PATHS contains /)"
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          # Get changed files
          CHANGED_FILES=$(gh pr diff "$PR_NUMBER" --name-only --repo "${{ github.repository }}")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files"
            echo "allowed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check each file against prefixes
          # Strip leading / from prefixes for comparison (git paths are relative)
          ALL_OK=true
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            FILE_OK=false
            for prefix in "${PREFIXES[@]}"; do
              compare="${prefix#/}"
              if [[ "$file" == "$compare"* ]]; then
                FILE_OK=true
                break
              fi
            done
            if [ "$FILE_OK" = "false" ]; then
              echo "BLOCKED: $file"
              ALL_OK=false
            fi
          done <<< "$CHANGED_FILES"

          echo "allowed=$ALL_OK" >> "$GITHUB_OUTPUT"

      - name: Merge PR
        if: steps.check-setting.outputs.enabled == 'true' && steps.check-paths.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --repo "${{ github.repository }}"
